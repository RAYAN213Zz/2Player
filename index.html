<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Versus Throw - Duel en Ligne</title>

<style>
    body {
        margin: 0;
        background: #0a0f1c;
        color: white;
        font-family: Arial, sans-serif;
        overflow: hidden;
    }
    #top {
        position: fixed;
        top: 0; left: 0; right: 0;
        height: 60px;
        background: rgba(0,0,0,0.3);
        backdrop-filter: blur(8px);
        display: flex;
        padding: 10px;
        align-items: center;
        gap: 10px;
        z-index: 100;
    }
    input {
        padding: 8px;
        border-radius: 8px;
        border: none;
        width: 120px;
    }
    button {
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        background: #18c4ff;
        cursor: pointer;
        color: #000;
    }
    #status {
        padding: 6px 10px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        font-size: 14px;
    }
    #canvas {
        position: absolute;
        top: 60px;
        left: 0;
        width: 100%;
        height: calc(100vh - 60px);
    }
</style>
</head>

<body>

<div id="top">
    <span id="status">Déconnecté</span>
    <input type="text" id="room" placeholder="Code salle">
    <button id="createBtn">Créer</button>
    <button id="joinBtn">Rejoindre</button>
</div>

<canvas id="canvas"></canvas>

<script>
// ======================================================
// VARIABLES GLOBALES
// ======================================================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let W, H;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight - 60;
}
resize();
window.addEventListener("resize", resize);

let socket = null;
let myId = null;
let myPlayer = null;

let game = {
    ball: { x: W/2, y: H/2, vx: 0, vy: 0 },
    goal: { x: W * 0.8, y: H / 2 },
    turn: "P1",
    scores: { P1: 0, P2: 0 }
};

// ======================================================
// RÉSEAU : CONNEXION À TON SERVEUR WEBSOCKET
// ======================================================
function connectToServer(roomCode) {
socket = new WebSocket("wss://twoplayer.onrender.com/?room=" + roomCode);

    document.getElementById("status").textContent = "Connexion...";

    socket.onopen = () => {
        document.getElementById("status").textContent = "Connecté";
        socket.send(JSON.stringify({ type: "join" }));
    };

    socket.onmessage = e => {
        let msg = JSON.parse(e.data);

        if (msg.type === "welcome") {
            myId = msg.id;
            myPlayer = msg.player;
        }

        if (msg.type === "state") {
            game = msg.game;
        }
    };

    socket.onerror = () => {
        document.getElementById("status").textContent = "Erreur WebSocket";
    };

    socket.onclose = () => {
        document.getElementById("status").textContent = "Déconnecté";
    };
}

// ======================================================
// TIR (DRAG + LANCER)
// ======================================================
let dragging = false;
let dragStart = null;

canvas.addEventListener("pointerdown", e => {
    if (game.turn !== myPlayer) return;
    dragging = true;
    dragStart = { x: e.clientX, y: e.clientY };
});

canvas.addEventListener("pointermove", e => {
    if (dragging) {
        dragStart.current = { x: e.clientX, y: e.clientY };
    }
});

canvas.addEventListener("pointerup", e => {
    if (!dragging) return;
    dragging = false;

    const dx = e.clientX - dragStart.x;
    const dy = e.clientY - dragStart.y;
    const power = Math.min(Math.hypot(dx, dy), 300) / 15;

    const vx = (dx / Math.max(1, Math.hypot(dx, dy))) * power;
    const vy = (dy / Math.max(1, Math.hypot(dx, dy))) * power;

    socket.send(JSON.stringify({
        type: "throw",
        vx, vy
    }));
});

// ======================================================
// ANIMATION
// ======================================================
function loop() {
    ctx.clearRect(0, 0, W, H);

    // terrain
    ctx.fillStyle = "#0b1222";
    ctx.fillRect(0, 0, W, H);

    // but
    ctx.beginPath();
    ctx.arc(game.goal.x, game.goal.y, 40, 0, Math.PI * 2);
    ctx.fillStyle = "#44ff44";
    ctx.fill();

    // balle
    ctx.beginPath();
    ctx.arc(game.ball.x, game.ball.y, 14, 0, Math.PI * 2);
    ctx.fillStyle = game.turn === "P1" ? "#7eff7a" : "#ff7ad1";
    ctx.fill();

    // ligne drag
    if (dragging && dragStart.current) {
        ctx.beginPath();
        ctx.moveTo(game.ball.x, game.ball.y);
        ctx.lineTo(dragStart.current.x, dragStart.current.y);
        ctx.strokeStyle = "#ffffff88";
        ctx.setLineDash([5,5]);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    requestAnimationFrame(loop);
}
loop();

// ======================================================
// UI : création / rejoindre room
// ======================================================
document.getElementById("createBtn").onclick = () => {
    const room = Math.random().toString(36).slice(2, 8).toUpperCase();
    document.getElementById("room").value = room;
    connectToServer(room);
};

document.getElementById("joinBtn").onclick = () => {
    const room = document.getElementById("room").value.trim();
    if (room.length < 2) return alert("Code invalide");
    connectToServer(room);
};
</script>

</body>
</html>
