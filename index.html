<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Versus Throw - Duel en Ligne</title>

<style>
    body {
        margin: 0;
        background: #0a0f1c;
        color: white;
        font-family: Arial, sans-serif;
        overflow: hidden;
    }
    #top {
        position: fixed;
        top: 0; left: 0; right: 0;
        height: 60px;
        background: rgba(0,0,0,0.3);
        backdrop-filter: blur(8px);
        display: flex;
        padding: 10px;
        align-items: center;
        gap: 10px;
        z-index: 100;
    }
    input {
        padding: 8px;
        border-radius: 8px;
        border: none;
        width: 140px;
    }
    button {
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        background: #18c4ff;
        cursor: pointer;
        color: #000;
    }
    #status {
        padding: 6px 10px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        font-size: 14px;
    }
    #canvas {
        position: absolute;
        top: 60px;
        left: 0;
        width: 100%;
        height: calc(100vh - 60px);
    }
</style>
</head>

<body>

<div id="top">
    <span id="status">Déconnecté</span>
    <input type="text" id="room" placeholder="Code salle">
    <button id="createBtn">Créer</button>
    <button id="joinBtn">Rejoindre</button>
</div>

<canvas id="canvas"></canvas>

<script>
// ======================================================
// VARIABLES
// ======================================================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let W, H;
function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight - 60;
}
resize();
window.addEventListener("resize", resize);

let socket = null;
let myPlayer = null;

let game = {
    ball: { x: 400, y: 300, vx: 0, vy: 0 },
    goal: { x: 700, y: 300 },
    turn: "P1"
};

// ======================================================
// CONNEXION AU SERVEUR
// ======================================================
function connectToServer(roomCode) {
    socket = new WebSocket("wss://twoplayer.onrender.com/?room=" + roomCode);

    document.getElementById("status").textContent = "Connexion...";

    socket.onopen = () => {
        document.getElementById("status").textContent = "Connecté";
    };

    socket.onmessage = e => {
        const msg = JSON.parse(e.data);

        if (msg.type === "welcome") {
            myPlayer = msg.player;
        }

        if (msg.type === "state") {
            game = msg.game;
        }
    };

    socket.onerror = () => {
        document.getElementById("status").textContent = "Erreur WebSocket";
    };

    socket.onclose = () => {
        document.getElementById("status").textContent = "Déconnecté";
    };
}

// ======================================================
// DRAG → LANCER
// ======================================================
let dragging = false;
let dragStart = null;
let currentPointer = null;

canvas.addEventListener("pointerdown", e => {
    if (game.turn !== myPlayer) return;

    dragging = true;
    dragStart = { x: e.clientX, y: e.clientY };
    currentPointer = dragStart;
});

canvas.addEventListener("pointermove", e => {
    if (!dragging) return;
    currentPointer = { x: e.clientX, y: e.clientY };
});

canvas.addEventListener("pointerup", e => {
    if (!dragging) return;

    dragging = false;

    const dx = currentPointer.x - dragStart.x;
    const dy = currentPointer.y - dragStart.y;

    const dist = Math.hypot(dx, dy);
    const power = Math.min(dist, 300) / 10;

    const vx = (dx / dist) * power;
    const vy = (dy / dist) * power;

    socket.send(JSON.stringify({
        type: "throw",
        vx, vy
    }));

    currentPointer = null;
});

// ======================================================
// RENDU
// ======================================================
function loop() {
    ctx.clearRect(0, 0, W, H);

    // Terrain
    ctx.fillStyle = "#0b1222";
    ctx.fillRect(0, 0, W, H);

    // But
    ctx.beginPath();
    ctx.arc(game.goal.x, game.goal.y, 40, 0, Math.PI * 2);
    ctx.fillStyle = "#44ff44";
    ctx.fill();

    // Balle
    ctx.beginPath();
    ctx.arc(game.ball.x, game.ball.y, 16, 0, Math.PI * 2);
    ctx.fillStyle = (game.turn === "P1") ? "#7eff7a" : "#ff7ad1";
    ctx.fill();

    // Ligne Drag
    if (dragging && currentPointer) {
        ctx.beginPath();
        ctx.moveTo(game.ball.x, game.ball.y);
        ctx.lineTo(currentPointer.x, currentPointer.y);
        ctx.strokeStyle = "#ffffff88";
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    requestAnimationFrame(loop);
}
loop();

// ======================================================
// UI
// ======================================================
document.getElementById("createBtn").onclick = () => {
    const code = Math.random().toString(36).slice(2, 8).toUpperCase();
    document.getElementById("room").value = code;
    connectToServer(code);
};

document.getElementById("joinBtn").onclick = () => {
    const code = document.getElementById("room").value.trim();
    if (code.length < 2) return alert("Code invalide");
    connectToServer(code);
};
</script>

</body>
</html>
