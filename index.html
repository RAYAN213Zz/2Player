<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Versus Throw</title>
<style>
    :root {
        --bg: #0b1020;
        --panel: #11182b;
        --accent: #7cf4ff;
        --p1: #7eff7a;
        --p2: #ff7ad1;
    }
    * { box-sizing: border-box; }
    body {
        margin: 0;
        background: radial-gradient(circle at 25% 20%, #0f1a33, #0b1020 60%);
        color: #e9f2ff;
        font-family: "Segoe UI", Tahoma, sans-serif;
        overflow: hidden;
    }
    header {
        position: fixed;
        top: 0; left: 0; right: 0;
        height: 70px;
        padding: 10px 12px;
        display: flex;
        gap: 8px;
        align-items: center;
        background: rgba(9,12,22,0.65);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255,255,255,0.05);
        z-index: 10;
    }
    header input {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.05);
        color: #e9f2ff;
        width: 120px;
    }
    header button {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(124,244,255,0.12);
        color: #e9f2ff;
        cursor: pointer;
    }
    #status {
        padding: 6px 10px;
        border-radius: 10px;
        background: rgba(255,255,255,0.08);
        font-size: 14px;
        min-width: 120px;
        text-align: center;
    }
    #info { display: flex; gap: 8px; align-items: center; }
    #info span {
        padding: 6px 10px;
        border-radius: 10px;
        background: rgba(255,255,255,0.08);
        font-size: 14px;
    }
    #canvas {
        position: absolute;
        top: 70px;
        left: 0;
        width: 100%;
        height: calc(100vh - 70px);
        touch-action: none;
    }
    #toast {
        position: fixed;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 14px;
        background: rgba(0,0,0,0.4);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        backdrop-filter: blur(8px);
        font-size: 14px;
        display: none;
    }
</style>
</head>
<body>
    <header>
        <span id="status">Déconnecté</span>
        <div id="info">
            <span id="you">Vous: ?</span>
            <span id="turn">Tour: ?</span>
            <span id="score">0 - 0</span>
        </div>
        <input id="room" placeholder="Code salle" maxlength="8" />
        <button id="create">Créer</button>
        <button id="join">Rejoindre</button>
    </header>
    <canvas id="canvas"></canvas>
    <div id="toast"></div>

<script>
// ----------------------------------------------------
// Réseau
// ----------------------------------------------------
const WS_URL = "wss://twoplayer.onrender.com";
let socket = null;
let myPlayer = null;

function logToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(logToast._timer);
    logToast._timer = setTimeout(() => t.style.display = "none", 2200);
}

function setStatus(text) {
    document.getElementById("status").textContent = text;
}

function connect(roomCode) {
    if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
        socket.close();
    }
    socket = new WebSocket(`${WS_URL}/?room=${roomCode}`);
    setStatus("Connexion...");
    socket.onopen = () => {
        setStatus("Connecté");
        socket.send(JSON.stringify({ type: "join" }));
    };
    socket.onerror = () => setStatus("Erreur WS");
    socket.onclose = () => setStatus("Déconnecté");
    socket.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === "welcome") {
            myPlayer = msg.player;
            document.getElementById("you").textContent = "Vous: " + myPlayer;
        }
        if (msg.type === "state") {
            applyState(msg.game);
        }
        if (msg.type === "toast") logToast(msg.message);
    };
}

// ----------------------------------------------------
// Etat client
// ----------------------------------------------------
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let W = 0, H = 0;
let game = {
    ball: { x: 0, y: 0, vx: 0, vy: 0 },
    goal: { x: 0, y: 0 },
    turn: "P1",
    scores: { P1: 0, P2: 0 },
    obstacles: []
};

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight - 70;
}
resize();
window.addEventListener("resize", resize);

function applyState(g) {
    game = g;
    document.getElementById("turn").textContent = "Tour: " + game.turn;
    document.getElementById("turn").style.color = game.turn === "P1" ? "var(--p1)" : "var(--p2)";
    document.getElementById("score").textContent = `${game.scores.P1} - ${game.scores.P2}`;
}

// ----------------------------------------------------
// Input
// ----------------------------------------------------
let dragging = false;
let dragStart = null; // always center of ball when drag is valid

canvas.addEventListener("pointerdown", (e) => {
    if (game.turn !== myPlayer) return;
    // exiger un appui proche de la balle
    const dx = e.clientX - game.ball.x;
    const dy = e.clientY - game.ball.y;
    if (Math.hypot(dx, dy) > 45) return;
    dragging = true;
    dragStart = { x: game.ball.x, y: game.ball.y };
});

canvas.addEventListener("pointermove", (e) => {
    if (dragging) {
        dragStart.current = { x: e.clientX, y: e.clientY };
    }
});

canvas.addEventListener("pointerup", (e) => {
    if (!dragging) return;
    dragging = false;
    if (!socket || socket.readyState !== WebSocket.OPEN) {
        logToast("Pas connecté");
        return;
    }
    const dx = e.clientX - dragStart.x;
    const dy = e.clientY - dragStart.y;
    const dist = Math.hypot(dx, dy);
    const power = Math.min(dist, 220) / 18; // tir plus court/controle
    const norm = Math.max(1, dist);
    const vx = dx / norm * power;
    const vy = dy / norm * power;
    socket.send(JSON.stringify({ type: "throw", vx, vy }));
});

// ----------------------------------------------------
// Render
// ----------------------------------------------------
function draw() {
    ctx.clearRect(0, 0, W, H);
    const grad = ctx.createLinearGradient(0, 0, W, H);
    grad.addColorStop(0, "#0b1328");
    grad.addColorStop(1, "#0a0f1f");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, W, H);

    // goal
    ctx.beginPath();
    ctx.arc(game.goal.x, game.goal.y, 36, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(124,244,255,0.15)";
    ctx.fill();
    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(124,244,255,0.5)";
    ctx.stroke();

    // obstacles
    ctx.fillStyle = "rgba(255,120,120,0.35)";
    ctx.strokeStyle = "rgba(255,120,120,0.7)";
    game.obstacles?.forEach(o => {
        ctx.beginPath();
        ctx.rect(o.x, o.y, o.w, o.h);
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.stroke();
    });

    // ball
    ctx.beginPath();
    ctx.arc(game.ball.x, game.ball.y, 14, 0, Math.PI * 2);
    ctx.fillStyle = game.turn === "P1" ? "var(--p1)" : "var(--p2)";
    ctx.fill();
    ctx.lineWidth = 3;
    ctx.strokeStyle = game.turn === "P1" ? "var(--p2)" : "var(--p1)";
    ctx.stroke();

    // arrow to goal
    ctx.beginPath();
    ctx.moveTo(game.ball.x, game.ball.y);
    const dirX = game.goal.x - game.ball.x;
    const dirY = game.goal.y - game.ball.y;
    const mag = Math.max(1, Math.hypot(dirX, dirY));
    const arrowLen = 50;
    const ax = game.ball.x + (dirX / mag) * arrowLen;
    const ay = game.ball.y + (dirY / mag) * arrowLen;
    ctx.lineTo(ax, ay);
    ctx.strokeStyle = "rgba(255,255,255,0.5)";
    ctx.lineWidth = 2;
    ctx.stroke();
    // arrow head
    const headSize = 8;
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(ax - (dirX / mag) * headSize - (dirY / mag) * headSize * 0.6, ay - (dirY / mag) * headSize + (dirX / mag) * headSize * 0.6);
    ctx.lineTo(ax - (dirX / mag) * headSize + (dirY / mag) * headSize * 0.6, ay - (dirY / mag) * headSize - (dirX / mag) * headSize * 0.6);
    ctx.closePath();
    ctx.fillStyle = "rgba(255,255,255,0.5)";
    ctx.fill();

    // drag helper
    if (dragging && dragStart?.current) {
        ctx.beginPath();
        ctx.moveTo(game.ball.x, game.ball.y);
        ctx.lineTo(dragStart.current.x, dragStart.current.y);
        ctx.strokeStyle = "#ffffff88";
        ctx.setLineDash([6, 6]);
        ctx.stroke();
        ctx.setLineDash([]);
    }
    requestAnimationFrame(draw);
}
draw();

// ----------------------------------------------------
// UI
// ----------------------------------------------------
document.getElementById("create").onclick = () => {
    const code = Math.random().toString(36).slice(2, 8).toUpperCase();
    document.getElementById("room").value = code;
    connect(code);
};
document.getElementById("join").onclick = () => {
    const code = document.getElementById("room").value.trim().toUpperCase();
    if (!code) return logToast("Code requis");
    connect(code);
};
</script>
</body>
</html>
